name: Fast and Lightweight Build and Deploy Documentation

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  pages: write

env:
  INSTANCE: 'Writerside/v'
  ARTIFACT: 'webHelpV2-all.zip'
  DOCKER_VERSION: '241.18775'
  ALGOLIA_ARTIFACT: 'algolia-indexes-V.zip'
  ALGOLIA_APP_NAME: 'FJLBFRYT23'
  ALGOLIA_INDEX_NAME: 'VultureEcho'
  ALGOLIA_KEY: '${{ secrets.ALGOLIA_KEY }}'
  CONFIG_JSON_PRODUCT: 'V'
  CONFIG_JSON_VERSION: '1.0'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 必要なコミットのみを取得

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /github/workspace/.docker
          key: ${{ runner.os }}-docker-${{ hashFiles('**/Dockerfile') }}

      - name: Build docs using Writerside Docker builder
        uses: JetBrains/writerside-github-action@v4
        with:
          instance: ${{ env.INSTANCE }}
          artifact: ${{ env.ARTIFACT }}
          docker-version: ${{ env.DOCKER_VERSION }}

      - name: Save artifact with build results
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: |
            artifacts/${{ env.ARTIFACT }}, artifacts/${{ env.ALGOLIA_ARTIFACT }}
          retention-days: 1  # 最短の保存期間

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: docs

      - name: Deploy to GitHub Pages using minimal setup
        run: |
          unzip -O UTF-8 -qq '${{ env.ARTIFACT }}' -d dir
          actions/configure-pages@v5
          actions/upload-pages-artifact@v3
          actions/deploy-pages@v4

  publish-indexes:
    needs: [build, deploy]
    runs-on: ubuntu-latest
    container:
      image: registry.jetbrains.team/p/writerside/builder/algolia-publisher:2.0.32-3
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: docs

      - name: Upload indexes to Algolia
        run: |
          unzip -O UTF-8 -qq '${{ env.ALGOLIA_ARTIFACT }}' -d algolia-indexes
          env algolia-key='${{ env.ALGOLIA_KEY }}' java -jar /opt/builder/help-publication-agent.jar \
          update-index \
          --application-name '${{ env.ALGOLIA_APP_NAME }}' \
          --index-name '${{ env.ALGOLIA_INDEX_NAME }}' \
          --product '${{ env.CONFIG_JSON_PRODUCT }}' \
          --version '${{ env.CONFIG_JSON_VERSION }}' \
          --index-directory algolia-indexes/